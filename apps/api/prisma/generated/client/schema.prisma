generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  CLINICIAN
}

enum ClinicianType {
  PSYCHOLOGIST
}

enum PatientStatus {
  ACTIVE
  ARCHIVED
  WAITLIST
}

enum AppointmentStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
}

enum AppointmentType {
  CONSULTATION
  EVALUATION
  FOLLOW_UP
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum NoteTemplateType {
  SOAP
  FREE
  INITIAL
  CBT
}

// ============================================
// MODELS
// ============================================

model User {
  id           String            @id @default(uuid()) @db.Uuid
  email        String            @unique
  passwordHash String            @map("password_hash")
  role         UserRole
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")
  profile      ClinicianProfile?
  accessLogs   AccessLog[]

  @@map("users")
}

model ClinicianProfile {
  id                     String        @id @default(uuid()) @db.Uuid
  userId                 String        @unique @map("user_id") @db.Uuid
  type                   ClinicianType
  licenseNumber          String?       @map("license_number")
  currency               String        @default("USD")
  sessionDefaultDuration Int           @default(50) @map("session_default_duration")
  sessionDefaultPrice    Decimal       @default(0.00) @map("session_default_price") @db.Decimal(10, 2)
  createdAt              DateTime      @default(now()) @map("created_at")
  updatedAt              DateTime      @updatedAt @map("updated_at")

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  patients     Patient[]
  appointments Appointment[]
  transactions FinanceTransaction[]

  @@map("clinician_profiles")
}

model Patient {
  id               String        @id @default(uuid()) @db.Uuid
  clinicianId      String        @map("clinician_id") @db.Uuid
  fullName         String        @map("full_name")
  dateOfBirth      DateTime?     @map("date_of_birth") @db.Date
  diagnosis        String?
  clinicalContext  String?       @map("clinical_context")
  status           PatientStatus @default(ACTIVE)
  contactPhone     String?       @map("contact_phone")
  emergencyContact Json?         @map("emergency_contact")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  clinician    ClinicianProfile @relation(fields: [clinicianId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  psychNotes   PsychNote[]
  accessLogs   AccessLog[]
  tasks        Task[]

  @@index([fullName])
  @@map("patients")
}

model Appointment {
  id            String            @id @default(uuid()) @db.Uuid
  patientId     String            @map("patient_id") @db.Uuid
  clinicianId   String            @map("clinician_id") @db.Uuid
  startTime     DateTime          @map("start_time")
  endTime       DateTime          @map("end_time")
  type          AppointmentType   @default(CONSULTATION)
  reason        String?
  status        AppointmentStatus @default(SCHEDULED)
  paymentStatus PaymentStatus     @default(PENDING) @map("payment_status")
  paymentMethod PaymentMethod?    @map("payment_method")
  price         Decimal           @db.Decimal(10, 2)
  notes         String?
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  patient     Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  clinician   ClinicianProfile    @relation(fields: [clinicianId], references: [id], onDelete: Cascade)
  psychNote   PsychNote?
  transaction FinanceTransaction?

  @@map("appointments")
}

model PsychNote {
  id            String           @id @default(uuid()) @db.Uuid
  appointmentId String           @unique @map("appointment_id") @db.Uuid
  patientId     String           @map("patient_id") @db.Uuid
  templateType  NoteTemplateType @map("template_type")
  content       Json
  moodRating    Int?             @map("mood_rating")
  privateNotes  String?          @map("private_notes")
  isPinned      Boolean          @default(false) @map("is_pinned")
  tags          String[]         @default([])
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patient     Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("psych_notes")
}

model Task {
  id          String    @id @default(uuid()) @db.Uuid
  patientId   String    @map("patient_id") @db.Uuid
  description String
  isCompleted Boolean   @default(false) @map("is_completed")
  dueDate     DateTime? @map("due_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model AccessLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  patientId String?  @map("patient_id") @db.Uuid
  action    String
  resource  String
  details   String?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  patient Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  @@map("access_logs")
}

model FinanceTransaction {
  id            String          @id @default(uuid()) @db.Uuid
  clinicianId   String          @map("clinician_id") @db.Uuid
  appointmentId String?         @unique @map("appointment_id") @db.Uuid
  type          TransactionType
  category      String          @default("General")
  amount        Decimal         @db.Decimal(10, 2)
  description   String?
  date          DateTime        @default(now())
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  clinician   ClinicianProfile @relation(fields: [clinicianId], references: [id], onDelete: Cascade)
  appointment Appointment?     @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@map("finance_transactions")
}
